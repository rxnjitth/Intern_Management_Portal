{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intern Dashboard - {{ user.username|default:"Intern" }} | IPS Interns</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{% static 'css/intern_dashboard_new.css' %}">
    <link rel="stylesheet" href="{% static 'css/intern_dashboard_extended.css' %}">
    <link rel="stylesheet" href="{% static 'css/dark_theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <script>
        // Apply theme immediately before DOM is ready to prevent flash of incorrect theme
        (function() {
            const savedTheme = localStorage.getItem('ips-theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-theme');
                document.body.classList.add('dark-theme');
            }
        })();
    </script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="{% static 'images/ips_logo.webp' %}" alt="IPS Logo" class="logo">
                    <span class="logo-text">IPS Interns</span>
                </div>
                <button class="mobile-close" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="profile-section">
                <div class="profile-img">
                    <i class="fas fa-user-circle" style="font-size: 80px;"></i>
                </div>
                <h4 class="profile-name">{{ user.username|default:"Intern" }}</h4>
                <span class="profile-title">Intern</span>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#tasks" class="nav-link">
                        <i class="fas fa-tasks nav-icon"></i>
                        <span>Task Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#certificate" class="nav-link">
                        <i class="fas fa-certificate nav-icon"></i>
                        <span>Certificate</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#progress" class="nav-link">
                        <i class="fas fa-chart-pie nav-icon"></i>
                        <span>Progress</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <!-- Footer content can be added here if needed -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Intern Dashboard</h1>
                <div class="header-actions">
                    <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Mode" data-bs-toggle="tooltip" data-bs-placement="bottom">
                        <i id="themeIcon" class="fas fa-moon"></i>
                        <span class="visually-hidden">Toggle Theme</span>
                    </button>
                    <a href="{% url 'custom_logout' %}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
            
            <!-- Flash Messages -->
            {% if messages %}
            <div class="flash-messages fade-in">
                {% for message in messages %}
                <div class="certificate-alert success">
                    <div class="certificate-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="certificate-content">
                        <div class="certificate-message">{{ message }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in" style="--delay: 0.1s">
                    <div class="stat-header">
                        <div class="stat-title">COMPLETED TASKS</div>
                        <div class="stat-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ submission_count }}</div>
                    <div class="stat-subtitle">Reports submitted</div>
                </div>
                
                <div class="stat-card fade-in" style="--delay: 0.2s">
                    <div class="stat-header">
                        <div class="stat-title">TOTAL DAYS</div>
                        <div class="stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ total_days }}</div>
                    <div class="stat-subtitle">Internship duration</div>
                </div>
                
                <div class="stat-card fade-in" style="--delay: 0.3s">
                    <div class="stat-header">
                        <div class="stat-title">PROGRESS</div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ progress }}%</div>
                    <div class="stat-subtitle">Completion rate</div>
                </div>
            </div>
            
            <!-- Submit Task Section -->
            <div class="card fade-in" id="submit-task">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-plus-circle card-icon"></i>
                        Submit Today's Task
                    </h2>
                </div>
                <div class="card-body">
                    <form method="post" class="task-form">
                        {% csrf_token %}
                        <div class="form-floating mb-3">
                            {{ form.topic }}
                            <label for="taskTopicField">What did you learn today?</label>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Submit Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="card fade-in" id="progress">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-pie card-icon"></i>
                        Your Progress Journey
                    </h2>
                </div>
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress-circle">
                            <svg class="progress-svg" width="200" height="200" viewBox="0 0 200 200">
                                <defs>
                                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
                                        <stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="circle-bg" cx="100" cy="100" r="90" />
                                <circle class="circle-progress" cx="100" cy="100" r="90"
                                    stroke-dasharray="565.48" 
                                    data-progress="{{ progress }}"
                                    stroke-dashoffset="{% widthratio progress 100 565.48 as offset %}{{ offset }}" />
                            </svg>
                            <div class="progress-text">
                                <div class="progress-value">{{ progress }}%</div>
                                <div class="progress-label">Complete</div>
                            </div>
                        </div>
                        <div class="progress-details">{{ submission_count }} of {{ total_days }} days completed</div>
                    </div>
                </div>
            </div>

            <!-- Certificate Section -->
            <div class="card fade-in" id="certificate">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-certificate card-icon"></i>
                        Your Achievement
                    </h2>
                </div>
                <div class="card-body">
                    <div class="certificate-section">
                        {% if progress == 100 %}
                            {% if is_certified %}
                                <div class="certificate-alert success">
                                    <div class="certificate-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="certificate-content">
                                        <div class="certificate-title">Congratulations!</div>
                                        <div class="certificate-message">Your certificate is ready for download!</div>
                                    </div>
                                </div>
                                <div class="certificate-preview">
                                    <img src="{% static 'images/certificate.png' %}" alt="Certificate Preview" class="img-fluid">
                                </div>
                                {% if user_role == 'INTERN' %}
                                    <div class="text-center mt-3">
                                        <a href="{% url 'download_certificate' %}" class="btn btn-success">
                                            <i class="fas fa-download"></i> Download Certificate
                                        </a>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="certificate-alert warning">
                                    <div class="certificate-icon warning">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="certificate-content">
                                        <div class="certificate-title">Almost There!</div>
                                        <div class="certificate-message">You've completed 100%. Awaiting admin approval.</div>
                                    </div>
                                </div>
                                <div class="certificate-preview position-relative">
                                    <img src="{% static 'images/certificate.png' %}" alt="Locked Certificate" class="img-fluid" style="filter: blur(4px);">
                                    <div class="position-absolute top-50 start-50 translate-middle fs-1 text-white">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert-modern alert-secondary">
                                <i class="fas fa-lock me-2"></i>
                                <strong>Locked:</strong> Complete all tasks to unlock your certificate.
                            </div>
                            <div class="certificate-preview">
                                <img src="{% static 'images/certificate.png' %}" alt="Locked Certificate" class="img-fluid" style="filter: blur(4px);">
                                <div class="certificate-lock">
                                    <i class="fas fa-lock"></i>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Task Reports Section -->
            <div class="card fade-in" id="tasks">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-history card-icon"></i>
                        Your Task History
                    </h2>
                </div>
                <div class="card-body">
                    {% if task_reports %}
                        <ul class="task-list">
                            {% for task in task_reports %}
                                <li class="task-item">
                                    <div class="task-date-container">
                                        <span class="task-date-day">{{ task.date|date:"d" }}</span>
                                        <span class="task-date-month">{{ task.date|date:"M" }}</span>
                                    </div>
                                    <div class="task-content">
                                        <div class="task-title">Day {{ forloop.counter }}</div>
                                        <div class="task-description">{{ task.topic|truncatechars:150 }}</div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                        <div class="text-center mt-4">
                            <a href="{% url 'download_task_reports_pdf' %}" class="btn btn-primary">
                                <i class="fas fa-file-pdf"></i> Download Reports
                            </a>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <div class="empty-title">No Reports Yet</div>
                            <div class="empty-message">No tasks submitted yet. Start your journey today!</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Footer -->
            {% include 'includes/footer.html' %}
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/theme_switcher.js' %}"></script>
    <script>
        // Apply animations and interactivity when document is ready
        $(document).ready(function() {
            // Animation for fade in elements
            $('.fade-in').each(function(index) {
                $(this).css('animation-delay', (index * 0.1) + 's');
                $(this).addClass('animate__animated animate__fadeIn');
            });
            
            // Mobile menu toggle
            $('#menuToggle').on('click', function() {
                $('#sidebar').addClass('active');
            });
            
            $('#closeSidebar').on('click', function() {
                $('#sidebar').removeClass('active');
            });
            
            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();
            
            // Enable dropdowns
            $('.dropdown-toggle').dropdown();
            
            // Handle circle progress visualization
            function adjustProgressCircle() {
                const progressCircle = $('.circle-progress');
                if (progressCircle.length === 0) return;
                
                // Get progress value from data attribute
                const progressValue = progressCircle.data('progress') || 0;
                
                // Calculate SVG circle properties
                const dashArray = 565.48; // 2πr where r=90
                const offset = dashArray - (progressValue / 100 * dashArray);
                
                // Apply calculation to stroke-dashoffset
                progressCircle.css('stroke-dashoffset', offset);
                
                // Responsive adjustments
                if (window.innerWidth <= 768) {
                    $('.progress-circle').css({
                        'width': '160px',
                        'height': '160px'
                    });
                } else if (window.innerWidth <= 576) {
                    $('.progress-circle').css({
                        'width': '140px',
                        'height': '140px'
                    });
                }
            }
            
            // Initialize and add window resize listener
            adjustProgressCircle();
            $(window).on('resize', adjustProgressCircle);
        });
    </script>
</body>
</html>